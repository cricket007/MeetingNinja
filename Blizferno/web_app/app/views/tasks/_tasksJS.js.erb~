var currentID;
var deleteID;
var tasksJSON = <%= raw @tasks %>;
tasksJSON = JSON.parse("["+tasksJSON.toString()+"]");

function hideTaskModal(){
	$('#viewTaskModal').modal('hide');
}

function cancelEdit(){
	showViewTaskModal(currentID);
}

function showEditModal(){
	$('#editTaskModal').modal('hide');
	$('#editTaskModal').on('hidden.bs.modal', function() {
		$(this).removeData('bs.modal');
	});

	document.getElementById("titleE").value = tasksJSON[currentID]["title"];
	document.getElementById("isCompletedE").checked = tasksJSON[currentID]["isCompleted"];
	document.getElementById("descriptionE").value = tasksJSON[currentID]["description"];
	document.getElementById("deadlineE").value = tasksJSON[currentID]["deadline"];
	document.getElementById("completionCriteriaE").value = tasksJSON[currentID]["completionCriteria"];
	document.getElementById("assignedToE").value = tasksJSON[currentID]["assignedTo"];

	$('#editTaskModal').modal('show');
	$('#viewTaskModal').modal('hide');
}

function updateEditedValues(){


	var editTaskID = tasksJSON[currentID]['taskID'].toString();
	var editField = "";
	var editValue = "";
	var editData = "";


	for (key in tasksJSON[currentID]){

		if(document.getElementById(key+"E") != null && tasksJSON[currentID][key] != document.getElementById(key+"E").value){
			tasksJSON[currentID][key] = document.getElementById(key+"E").value;

			editField = key;
			editValue = tasksJSON[currentID][key];
			editData = JSON.stringify({"taskID":editTaskID,"field":editField,"value":editValue});

			$.ajax({
				type: 'PUT',
				url: 'http://csse371-04.csse.rose-hulman.edu/Task/',
				data: editData
			});

		}
	}

}


function showDeleteModal(ID){
	deleteID = ID;
	$('#deleteTaskModal').modal('show');
}

function hideDeleteModal(){

	var deleteData = tasksJSON[deleteID]['taskID'];
	
	$.ajax({
		type: 'DELETE',
		url: 'http://csse371-04.csse.rose-hulman.edu/Task/'+deleteData,
		success:function(data){
			if(data.deleted == true){
				delete tasksJSON[deleteID];
			}
		}
	});

	$('#deleteTaskModal').modal('hide');
	// TODO: Put back in
	//location.reload(true);
}



function showViewTaskModalNoID(){
	updateEditedValues();
	showViewTaskModal(currentID);
}

function showViewTaskModal(ID){
	$('#viewTaskModal').modal('hide');
	$('#viewTaskModal').on('hidden.bs.modal', function() {
		$(this).removeData('bs.modal');
	});

	currentID = ID;

	document.getElementById("titleV").innerHTML = tasksJSON[currentID]["title"];
	document.getElementById("isCompletedV").innerHTML = "false";
	document.getElementById("descriptionV").innerHTML = tasksJSON[currentID]["description"];
	document.getElementById("deadlineV").innerHTML = "02/13/2014 13:33";
	document.getElementById("dateCreatedV").innerHTML = "02/08/2014 10:01";
	document.getElementById("dateAssignedV").innerHTML = "02/08/2014 10:01";
	document.getElementById("completionCriteriaV").innerHTML = tasksJSON[currentID]["completionCriteria"];
	document.getElementById("assignedToV").innerHTML = "5454";
	document.getElementById("assignedFromV").innerHTML ="5454";
	document.getElementById("createdByV").innerHTML = "5454";

	$('#viewTaskModal').modal('show');
	$('#editTaskModal').modal('hide');
}

function validateForm(){
	var title = document.forms["input"]["title"].value;
	var description = document.forms["input"]["description"].value;
	var deadline = document.forms["input"]["deadline"].value;
	var completionCriteria = document.forms["input"]["completionCriteria"].value;
	var assignedTo = document.forms["input"]["assignedTo"].value;

	if(title.length == 0 || description.length == 0 || !checkDeadlineFormat(deadline) || completionCriteria.length == 0 || assignedTo.length == 0) {
		var string = "The following fields need filled or modified: \n\n";
		if(title.length == 0) string = string + "Title\n";
		if(description.length == 0) string = string + "Description\n";
		if(!checkDeadlineFormat(deadline)) string = string + "Deadline (format = 'MM/DD/YYYY_HH:MM', where the underscore is a space)\n";
		if(completionCriteria.length == 0) string = string + "Completion Criteria\n";
		if(assignedTo.length == 0) string = string + "Assigned To\n";
		alert(string);
		return false;
	}else{
		alert("The following fields were added to the db: " + title + " " + description + " " + deadline + " " + completionCriteria + " " + assignedTo)
		return true;
	}
}

function checkDeadlineFormat(deadline){
	if(deadline.length == 0) return false;
	else {
		var array = deadline.split('');
		var date = new Date()
		var month = parseInt(deadline.substring(0,2));
		var day = parseInt(deadline.substring(3,5));
		var year = parseInt(deadline.substring(6, 10));
		var hours = parseInt(deadline.substring(11, 13));
		var minutes = parseInt(deadline.substring(14, 16));
		if(!(!isNaN(array[0]) && !isNaN(array[1]) && !isNaN(array[3]) && !isNaN(array[4]) && !isNaN(array[6]) && !isNaN(array[7]) && !isNaN(array[8]) && !isNaN(array[9]) && !isNaN(array[11]) && !isNaN(array[12]) && !isNaN(array[14]) && !isNaN(array[15]))) return false;
		else if(array[2] != '/' || array[5] != '/' || array[10] != ' ' || array[13] != ':') return false;
		else if(day > 31 || day == 0 || month > 12 || month == 0 || year < date.getFullYear() || hours > 23 || minutes > 59) return false;
		else return true;
	}
}
