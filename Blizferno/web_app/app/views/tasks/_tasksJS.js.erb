var currentID;
var deleteID;
var tasksJSON = <%= raw @tasks %>;
tasksJSON = JSON.parse("["+tasksJSON.toString()+"]");
var allUsers = <%= raw @allUsersRaw %>;
allUsers = JSON.parse(JSON.stringify(allUsers));

// var select = formJSON.assignedTo;
// var selIndex;
// var selValue;

// select.onchange = function() {
//     selIndex = select.selectedIndex;
//     selValue = select.options(selIndex).innerHTML;
// }

function hideTaskModal(){
	$('#viewTaskModal').modal('hide');
}

function cancelEdit(){
	showViewTaskModal(currentID);
	$('#editTaskModal').modal('hide');
}

function showEditModal(){
	$('#editTaskModal').modal('hide');
	$('#editTaskModal').on('hidden.bs.modal', function() {
		$(this).removeData('bs.modal');
	});

	document.getElementById("titleE").value = tasksJSON[currentID]["title"];
	document.getElementById("isCompletedE").checked = tasksJSON[currentID]["isCompleted"];
	document.getElementById("descriptionE").value = tasksJSON[currentID]["description"];

	var dateTime = tasksJSON[currentID]["deadline"];
	dateTime = (new Date(dateTime * 1000)).toLocaleString();
	dateTime = dateTime.split(" ");
	var date = dateTime[0].split("/");
	var month;
	var day;

	if(date[0].length == 1) month = "0" + date[0];
	else month = date[0];
	if(date[1].length == 1) day = "0" + date[1];
	else day = date[1];

	date = date[2] + "-" + month + "-" + day;

	var time = dateTime[1].split(":");
	var intHour;
	if(dateTime[2] == "PM"){
		intHour = parseInt(time[0]) + 12;
		time = intHour + ":" + time[1];
	}
	else{
		intHour = parseInt(time[0]);
		if(intHour < 10)
			time = "0" + intHour + ":" + time[1];
		else
			time = intHour + ":" + time[1];
	}

	document.getElementById("deadlinedateE").value = date;
	document.getElementById("deadlinetimeE").value = time;

	document.getElementById("completionCriteriaE").value = tasksJSON[currentID]["completionCriteria"];
	
	//populateSelect(allUsers['users'], "name", "userID", tasksJSON[currentID]["assignedTo"], "grpMemSlct");

	$('#editTaskModal').modal('show');
	$('#viewTaskModal').modal('hide');
}

function validateEditedValues(){
	var editTaskID = tasksJSON[currentID]['taskID'].toString();
	var invalidFields = false;

	for (key in tasksJSON[currentID]){
		if(document.getElementById(key+"E") != null && key != "isCompleted" && document.getElementById(key+"ER") != null){
			if(document.getElementById(key+"E").value == ""){
				invalidFields = true;
				document.getElementById(key+"ER").style.display = "inline";
			}
			else{
				document.getElementById(key+"ER").style.display = "none";
			}
		}
	}

	var additionalkeys = ["deadlinetime","deadlinedate"]
	for (key in additionalkeys){
		if(document.getElementById(additionalkeys[key]+"E") != null && document.getElementById(additionalkeys[key]+"ER") != null){
			if(document.getElementById(additionalkeys[key]+"E").value == ""){
				invalidFields = true;
				document.getElementById(additionalkeys[key]+"ER").style.display = "inline";
			}
			else{
				document.getElementById(additionalkeys[key]+"ER").style.display = "none";
			}
		}
	}

	// Check dates
	var date = document.getElementById("deadlinedateE").value.split("-");
	var time = document.getElementById("deadlinetimeE").value.split(":");
	var datetime = new Date(date[0], date[1]-1, date[2], time[0], time[1]);
	datetime = datetime.getTime()/1000.0;
	var deadline = datetime;

	var dateNow = (new Date).getTime();

	if(!(deadline*1000 > dateNow)){
		invalidFields = true;
		alert("Invalid deadline date/time");
	}

	return invalidFields
}

function updateEditedValues(){


	var editTaskID = tasksJSON[currentID]['taskID'].toString();
	var editField = "";
	var editValue = "";
	var editData = "";

	// Deadline date/time
	var splitTime = document.getElementById("deadlinetimeE").value.split(":");
	var splitDate = document.getElementById("deadlinedateE").value.split("-");
	var datetime = new Date(splitDate[0], splitDate[1]-1, splitDate[2], splitTime[0], splitTime[1]);
	datetime = datetime.getTime()/1000.0;

	// Just the deadline...
	editData = JSON.stringify({"taskID":editTaskID,"field":"deadline","value":datetime});

	ajaxRequest(editData, 'PUT', '/Task/', false, 'null')

	// Everything else
	for (key in tasksJSON[currentID]){
		if(key != "deadline"){
			if(document.getElementById(key+"E") != null){
				if(key == "isCompleted" && document.getElementById(key+"E").checked != tasksJSON[currentID][key]){
					tasksJSON[currentID][key] = document.getElementById(key+"E").checked;
					editField = key;
					editValue = tasksJSON[currentID][key];
					editData = JSON.stringify({"taskID":editTaskID,"field":editField,"value":editValue});

					ajaxRequest(editData, 'PUT', '/Task/', false, 'null');
				}
				else if(tasksJSON[currentID][key] != document.getElementById(key+"E").value){
					tasksJSON[currentID][key] = document.getElementById(key+"E").value;

					editField = key;
					editValue = tasksJSON[currentID][key];
					editData = JSON.stringify({"taskID":editTaskID,"field":editField,"value":editValue});

					ajaxRequest(editData, 'PUT', '/Task/', false, 'null');

				}
			}
		}
	}

	window.location.reload(true);
}

function showDeleteModal(ID){
	deleteID = ID;
	$('#deleteTaskModal').modal('show');
}

function hideDeleteModal(){

	var deleteData = tasksJSON[deleteID]['taskID'];

	var onSuccess = function(data){
						if(JSON.parse(data)["valid"] == "true"){
						delete tasksJSON[deleteID];
						window.location.reload(true);
						}
					}

	ajaxRequest('null', 'DELETE', '/Task/' + deleteData, true, onSuccess)

	$('#deleteTaskModal').modal('hide');
}

function showViewTaskModalNoID(){
	var invalid = validateEditedValues();
	if (!invalid){
		updateEditedValues();
		showViewTaskModal(currentID);
	}
}

function showViewTaskModal(ID){
	$('#viewTaskModal').modal('hide');
	$('#viewTaskModal').on('hidden.bs.modal', function() {
		$(this).removeData('bs.modal');
	});

	currentID = ID;

	document.getElementById("titleV").innerHTML = tasksJSON[currentID]["title"];

	if(tasksJSON[currentID]["isCompleted"] == "on")
	{
	document.getElementById("isCompletedV").innerHTML = "True";
	}else{
		document.getElementById("isCompletedV").innerHTML = tasksJSON[currentID]["isCompleted"]
	}
	document.getElementById("descriptionV").innerHTML = tasksJSON[currentID]["description"];
	
	var dt = tasksJSON[currentID]["deadline"];
	dt = new Date(dt * 1000);
	document.getElementById("deadlineV").innerHTML = dt.toLocaleString();
	dt = tasksJSON[currentID]["dateCreated"];
	dt = new Date(dt * 1000);
	document.getElementById("dateCreatedV").innerHTML = dt.toLocaleString();

	document.getElementById("completionCriteriaV").innerHTML = tasksJSON[currentID]["completionCriteria"];

	var successAssignmentTo = function(data){
								assignedTo = JSON.parse(data);
							}
	ajaxRequest('null', 'GET', '/User/' + tasksJSON[currentID]["assignedTo"] , false, successAssignmentTo);

	var successAssignmentFrom = function(data){
								assignedFrom = JSON.parse(data);
							}
	ajaxRequest('null', 'GET', '/User/' + tasksJSON[currentID]["assignedFrom"] , false, successAssignmentFrom);

	var successCreation = function(data){
								createdBy = JSON.parse(data);
							}
	ajaxRequest('null', 'GET', '/User/' + tasksJSON[currentID]["createdBy"] , false, successCreation);

	document.getElementById("assignedToV").innerHTML = assignedTo["name"];
	document.getElementById("assignedFromV").innerHTML = assignedFrom["name"];
	document.getElementById("createdByV").innerHTML = createdBy["name"];

	$('#viewTaskModal').modal('show');
	$('#editTaskModal').modal('hide');
}

function validateForm(){
	var title = document.forms["input"]["title"].value;
	var description = document.forms["input"]["description"].value;
	var deadline = document.forms["input"]["deadline"].value;
	var completionCriteria = document.forms["input"]["completionCriteria"].value;
	var assignedTo = document.forms["input"]["assignedTo"].value;

	if(title.length == 0 || description.length == 0 || !checkDeadlineFormat(deadline) || completionCriteria.length == 0 || assignedTo.length == 0) {
		var string = "The following fields need filled or modified: \n\n";
		if(title.length == 0) string = string + "Title\n";
		if(description.length == 0) string = string + "Description\n";
		if(!checkDeadlineFormat(deadline)) string = string + "Deadline (format = 'MM/DD/YYYY_HH:MM', where the underscore is a space)\n";
		if(completionCriteria.length == 0) string = string + "Completion Criteria\n";
		if(assignedTo.length == 0) string = string + "Assigned To\n";
		alert(string);
		return false;
	}else{
		alert("The following fields were added to the db: " + title + " " + description + " " + deadline + " " + completionCriteria + " " + assignedTo)
		return true;
	}
}

function checkDeadlineFormat(deadline){
	if(deadline.length == 0) return false;
	else {
		var array = deadline.split('');
		var date = new Date()
		var month = parseInt(deadline.substring(0,2));
		var day = parseInt(deadline.substring(3,5));
		var year = parseInt(deadline.substring(6, 10));
		var hours = parseInt(deadline.substring(11, 13));
		var minutes = parseInt(deadline.substring(14, 16));
		if(!(!isNaN(array[0]) && !isNaN(array[1]) && !isNaN(array[3]) && !isNaN(array[4]) && !isNaN(array[6]) && !isNaN(array[7]) && !isNaN(array[8]) && !isNaN(array[9]) && !isNaN(array[11]) && !isNaN(array[12]) && !isNaN(array[14]) && !isNaN(array[15]))) return false;
		else if(array[2] != '/' || array[5] != '/' || array[10] != ' ' || array[13] != ':') return false;
		else if(day > 31 || day == 0 || month > 12 || month == 0 || year < date.getFullYear() || hours > 23 || minutes > 59) return false;
		else return true;
	}
}

function submitCreateModal(){
	//grab the form from the html document
	var form = document.getElementById('createTask');
	//still testing validation

	//parse it into a json object
	var formJSON = new convertFormToJSON(form);
	var invalid = validateTaskForm(formJSON);
	if (!invalid){
		//manually grab the values for each field expected by the backend
		var userID = <%=@userID%>;
		var postTitle = formJSON.title;
		var postisCompleted = false;
		var postDescription = formJSON.description;

		var date = formJSON.deadlinedate.split("-");
		var time = formJSON.deadlinetime.split(":");
		var datetime = new Date(date[0], date[1]-1, date[2], time[0], time[1]);
		datetime = datetime.getTime()/1000.0;
		var postDeadline = datetime;

		var dt = formJSON.dateCreated.split(" ");
		date = dt[0].split("-");
		time = dt[1].split(":");
		datetime = new Date(date[0], date[1]-1, date[2], time[0], time[1]);
		datetime = datetime.getTime()/1000.0;
		var postDateCreated = datetime;

		dt = formJSON.dateAssigned.split(" ");
		date = dt[0].split("-");
		time = dt[1].split(":");
		datetime = new Date(date[0], date[1]-1, date[2], time[0], time[1]);
		datetime = datetime.getTime()/1000.0;
		var postDateAssigned = datetime;

		var postCompletionCriteria = formJSON.completionCriteria;
		var postAssignedFrom = <%=@userID%>;
		var postCreatedBy = <%=@userID%>;
		var postAssignedTo = formJSON.assignedTo;//.options[formJSON.assignedTo.selectedIndex].value;

		var attendees = getMembers('assignedTo');
		var postAttendance = [];

		for (var i = attendees.length - 1; i >= 0; i--) {
		  postAttendance.push({"userID":attendees[i]});
		};

		//set up the data for the call
		var postData = JSON.stringify({
			"title":postTitle,
			"isCompleted":postisCompleted,
			"description":postDescription,
			"deadline":postDeadline,
			"dateCreated":postDateCreated,
			"dateAssigned":postDateAssigned,
			"completionCriteria":postCompletionCriteria,
			"assignedTo":postAssignedTo,
			"assignedFrom":postAssignedFrom,
			"createdBy":postCreatedBy
		});
		var success = function(data){
						$('#newTaskModal').modal('hide');
						alert("Task successfully created! Reloading page...")
						window.location.reload(true);
					}
		ajaxRequest(postData, 'POST', '/Task/', true, success);

	}
}

function validateTaskForm(JSONForm){
	var invalidFields = false;

	for (key in JSONForm){
		if(document.getElementById(key+"R") != null){
			if(JSONForm[key] == ""){
				invalidFields = true;
				document.getElementById(key+"R").style.display = "inline";
			}
			else{
				document.getElementById(key+"R").style.display = "none";
			}
		}
	}

	var additionalkeys = ["deadlinetime","deadlinedate"];
	for (key in additionalkeys){
		if(document.getElementById(additionalkeys[key]) != null && document.getElementById(additionalkeys[key]+"R") != null){
			if(document.getElementById(additionalkeys[key]).value == ""){
				invalidFields = true;
				document.getElementById(additionalkeys[key]+"R").style.display = "inline";
			}
			else{
				document.getElementById(additionalkeys[key]+"R").style.display = "none";
			}
		}
	}

	//Check dates
	var date = document.getElementById("deadlinedate").value.split("-");
	var time = document.getElementById("deadlinetime").value.split(":");
	var datetime = new Date(date[0], date[1]-1, date[2], time[0], time[1]);
	datetime = datetime.getTime()/1000.0;
	var deadline = datetime;

	var dateNow = (new Date).getTime();

	if(!(deadline*1000 > dateNow) && !invalidFields){
		invalidFields = true;
		alert("Invalid deadline date/time");
	}

	return invalidFields;
}
