var currentID;
var deleteID;
var projectID;
var projectArray;
var projectsJSON = <%= raw @projects %>;
projectsJSON = JSON.parse("["+projectsJSON.toString()+"]");

var allUsers = <%= raw @allUsersRaw %>;
allUsers = JSON.parse(JSON.stringify(allUsers));

var allMeetings = <%= raw @userMeetingsRaw %>;
allMeetings = JSON.parse(JSON.stringify(allMeetings));


function hideViewModal(){
  $('#viewProjectModal').modal('hide');
}

function showDeleteModal(ID){
  currentID = ID;
  deleteID = projectsJSON[currentID]["projectID"].toString();
  $('#deleteProjectModal').modal('show');
}

function hideDeleteModal(){
  var doOnSuccess = function(data){
                      if(JSON.parse(data)["valid"] == "true"){
                        $('#deleteProjectModal').modal('hide');
                        window.location.reload(true);
                      }
                    }
  ajaxRequest('null', 'DELETE', '/Project/' + deleteID, true, doOnSuccess);
}

function showEditModal(ID){
  var meetingInfo, currentMeetings = new Array(), mid1;
  var memberInfo, currentMembers = new Array(), mid2;

  $('#editProjectModal').modal('hide');
  $('#editProjectModal').on('hidden.bs.modal', function() {
    $(this).removeData('bs.modal');
  });

  currentID = ID;
  projectID = projectsJSON[currentID]["projectID"].toString();
  var doOnSuccess = function(data){
                      setProjectArray(data);
                    }
  ajaxRequest('null', 'GET', '/Project/' + projectID, false, doOnSuccess);

  doOnSuccess = function(data){
                  meetingInfo = JSON.parse(data);
                  currentMeetings.push({'mid1':mid1,'title':meetingInfo['title']});
                }
  for (i in projectArray['meetings']){
    mid1 = projectArray['meetings'][i]['meetingID'];
    ajaxRequest('null', 'GET', '/Meeting/' + mid1, false, doOnSuccess);
  }

  doOnSuccess = function(data){
                  memberInfo = JSON.parse(data);
                  currentMembers.push({'mid2':mid2,'name':memberInfo['name']});
                }
  for (i in projectArray['members']){
    mid2 = projectArray['members'][i]['userID'];
    ajaxRequest('null', 'GET', '/User/' + mid2, false, doOnSuccess);
  }

  document.getElementById("titleE").value = projectArray['projectTitle'];

  populateSelect([], "title", "mid1", currentMeetings, "TableMeetingsE");
  populateSelect([], "name", "mid2", currentMembers, "TableMembersE");

  $('#editProjectModal').modal('show');
}

function setProjectArray(d){
  projectArray = JSON.parse(d);
}

function showEditModalNoID(){
  showEditModal(currentID);
}

function cancelEdit(){
  showViewModal(currentID);
}

function validateEditedValues(){
  var editTaskID = currentID;
  var invalidFields = false;

  if(document.getElementById("titleE") != null && document.getElementById("titleER") != null){
    if(document.getElementById("titleE").value == ""){
      invalidFields = true;
      document.getElementById("titleER").style.display = "inline";
    }
    else{
      document.getElementById("titleER").style.display = "none";
    }
  }

  if(document.getElementById("TableMeetingsE") != null && document.getElementById("TableMeetingsER") != null){
    if(!hasSelectedValue("TableMeetingsE")){
      invalidFields = true;
      document.getElementById("TableMeetingsER").style.display = "inline";
    }
    else{
      document.getElementById("TableMeetingsER").style.display = "none";
    }
  }

  if(document.getElementById("TableMembersE") != null && document.getElementById("TableMembersER") != null){
    if(!hasSelectedValue("TableMembersE")){
      invalidFields = true;
      document.getElementById("TableMembersER").style.display = "inline";
    }
    else{
      document.getElementById("TableMembersER").style.display = "none";
    }
  }

  return invalidFields
}

function submitEditModal(){
  var form = new convertFormToJSON(document.getElementById('editProjectForm'));
  var invalid = validateEditedValues();
  if (!invalid){
    var postTitle = form.title;

    var meetings = getMembers('TableMeetingsE');
    var members = getMembers('TableMembersE');

    var postMeetings = new Array();
    var postMembers = new Array();

    for (var i = meetings.length - 1; i >= 0; i--){
      postMeetings.push({"meetingID":meetings[i]});
    };

    for (var i = members.length - 1; i >= 0; i--){
      postMembers.push({"userID":members[i]});
    };

    var updateTitle = JSON.stringify({"projectID":projectID,"field":"projectTitle","value":postTitle});
    var updateMeetings = JSON.stringify({"projectID":projectID,"field":"meetings","value":postMeetings});
    var updateMembers = JSON.stringify({"projectID":projectID,"field":"members","value":postMembers});

    ajaxRequest(updateTitle, 'PUT', '/Project/', false, 'null');
    ajaxRequest(updateMeetings, 'PUT', '/Project/', true, 'null');

    var doOnSuccess = function(data){
                        $('#editProjectModal').modal('hide');
                        $('#viewProjectModal').modal('hide');
                        window.location.reload(true);
                      }
    ajaxRequest(updateMembers, 'PUT', '/Project/', true, doOnSuccess);
  }
}

function showViewModal(ID){
  var meetingInfo;
  var memberInfo;
  var projectMeetings = new Array();
  var projectMembers = new Array();

  $('#viewProjectModal').modal('hide');
  $('#viewProjectModal').on('hidden.bs.modal', function() {
    $(this).removeData('bs.modal');
  });

  currentID = ID;
  projectID = projectsJSON[currentID]["projectID"].toString();
  var doOnSuccess = function(data){
                      projectArray = JSON.parse(data);
                    }
  ajaxRequest('null', 'GET', '/Project/' + projectID, false, doOnSuccess);

  doOnSuccess = function(data){
                  meetingInfo = JSON.parse(data);
                  projectMeetings.push({'title':meetingInfo['title']});
                }
  for (i in projectArray['meetings']){
    ajaxRequest('null', 'GET', '/Meeting/' + projectArray['meetings'][i]['meetingID'], false, doOnSuccess);
  }

  doOnSuccess = function(data){
                  memberInfo = JSON.parse(data);
                  projectMembers.push({'name':memberInfo['name']});
                } 
  for (i in projectArray['members']){
    ajaxRequest('null', 'GET', '/User/' + projectArray['members'][i]['userID'], false, doOnSuccess);
  }

  document.getElementById("titleV").innerHTML = projectArray["projectTitle"];
  populateTableRows(projectMeetings, "title", "TableMeetingsV");
  populateTableRows(projectMembers, "name", "TableMembersV");

  $('#viewProjectModal').modal('show');
  $('#editProjectModal').modal('hide');
}




