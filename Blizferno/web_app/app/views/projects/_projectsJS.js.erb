var ProjectArray;
  var currentID;
  var deleteID;
  var projectsJSON = <%= raw @projects %>;
  projectsJSON = JSON.parse("["+projectsJSON.toString()+"]");

  var allUsers = <%= raw @allUsersRaw %>;
  allUsers = JSON.parse(JSON.stringify(allUsers));

  var allNotes = <%= raw @userNotesRaw %>;
  allNotes = JSON.parse(JSON.stringify(allNotes));

  var allMeetings = <%= raw @userMeetingsRaw %>;
  allMeetings = JSON.parse(JSON.stringify(allMeetings));
  

  function hideViewModal(){
    $('#viewProjectModal').modal('hide');
  }

  function showDeleteModal(ID){
    deleteID = ID;
    $('#deleteProjectModal').modal('show');
  }

  function hideDeleteModal(){
      var deleteData = projectsJSON[deleteID]['projectID'];

      $.ajax({
        type: 'DELETE',
        url: 'http://csse371-04.csse.rose-hulman.edu/Project/' + deleteData,
        success:function(data){
            if(JSON.parse(data)["valid"] == "true"){
              $('#deleteProjectModal').modal('hide');
              window.location.reload(true);
            }
        }
      });
  }

  function showEditModal(ID){
    $('#editProjectModal').modal('hide');
    $('#editProjectModal').on('hidden.bs.modal', function() {
      $(this).removeData('bs.modal');
    });

    currentID = ID;

    document.getElementById("titleE").value = projectsJSON[currentID]["projectTitle"];

    populateSelect(allMeetings['meetings'], "title", "id", projectsJSON[currentID]["meetings"], "TableMeetingsE");
    populateSelect(allNotes['notes'], "title", "noteID", projectsJSON[currentID]["notes"], "TableNotesE");
    populateSelect(allUsers['users'], "name", "userID", projectsJSON[currentID]["members"], "TableMembersE");

    $('#editProjectModal').modal('show');
    $('#viewProjectModal').modal('hide');
  }

  function showEditModalNoID(){

    showEditModal(currentID);
  }

  function cancelEdit(){
    showViewModal(currentID);
  }

  function showViewModalNoID(){
    updateEditedValues();
    showViewModal(currentID);
  }

  function submitEditModal(){
    var form = new convertFormToJSON(document.getElementById('editProjectForm'));

    var postTitle = form.title;
  
    var meetings = getElements('TableMeetingsE');
    var notes = getElements('TableNotesE');
    var members = getElements('TableMembersE');

    var postMeetings = [];
    var postNotes = [];
    var postMembers = [];

    for (var i = meetings.length - 1; i>=0; i--){
      postMeetings.push({"meetingID":meetings[i]});
    };

    for (var i = notes.length - 1; i>=0; i--){
      postNotes.push({"noteID":notes[i]});
    };

    for (var i = members.length - 1; i>= 0; i--) {
      postMembers.push({"userID":members[i]});
    };
    var postData = JSON.stringify({
        "projectTitle":postTitle,
        "meetings":postMeetings,
        "notes":postNotes,
        "members":postMembers
      });

    $.ajax({
      type: 'DELETE',
      url: 'http://csse371-04.csse.rose-hulman.edu/Project/' + currentID,
      success:function(data){
        // do nothing
      },
      async: false
    });

    $.ajax({
      type: 'POST',
      url: 'http://csse371-04.csse.rose-hulman.edu/Project/',
      data: postData,
      success:function(data){
        $('#editGroupModal').modal('hide');
        $('#newGroupModal').modal('hide');
        window.location.reload(true);
      }
    });

  }

  function showViewModal(ID){
    var meetingInfo;
    var notesInfo;
    var memberInfo;
    var projectMeetings = new Array();
    var projectNotes = new Array();
    var projectMembers = new Array();

    $('#viewProjectModal').modal('hide');
    $('#viewProjectModal').on('hidden.bs.modal', function() {
      $(this).removeData('bs.modal');
    });

    currentID = ID;

    document.getElementById("titleV").innerHTML = projectsJSON[currentID]["projectTitle"];

    // Get meetings
    for(meeting in projectsJSON[currentID]["meetings"]){
      $.ajax({
        type: 'GET',
        url: 'http://csse371-04.csse.rose-hulman.edu/Meeting/' + projectsJSON[currentID]["meetings"][meeting]['meetingID'],
        success:function(data){
          meetingInfo = JSON.parse(data);
          projectMeetings.push({'title':meetingInfo['title']});
        },
        async: false
      });
    }

    // Get notes
    for(note in projectsJSON[currentID]["notes"]){
      $.ajax({
        type: 'GET',
        url: 'http://csse371-04.csse.rose-hulman.edu/Note/' +projectsJSON[currentID]["notes"][note]['noteID'],
        success:function(data){
          noteInfo = JSON.parse(data);
          projectNotes.push({'title':noteInfo['title']});
        },
        async: false
      });
    }

    // Get members
    for(member in projectsJSON[currentID]["members"]){
    $.ajax({
        type: 'GET',
        url: 'http://csse371-04.csse.rose-hulman.edu/User/' + projectsJSON[currentID]["members"][member]['userID'],
        success:function(data){
          memberInfo = JSON.parse(data);
          projectMembers.push({'name':memberInfo['name']});
        },
        async: false
      });
    }

    populateTableRows(projectMeetings, "title", "TableMeetingsV");
    populateTableRows(projectNotes, "title", "TableNotesV");
    populateTableRows(projectMembers, "name", "TableMembersV");


    $('#viewProjectModal').modal('show');
    $('#editProjectModal').modal('hide');
  }

  function populateTableRows(JSONArray, JSONDisplayColumn, tableID){
    var table = document.getElementById(tableID);

    if(table.rows.length != 0){
      for(var i = table.rows.length - 1; i > -1; i--){
        table.deleteRow(i);
      }
    }

    for (var k in JSONArray){
      var rowCount = table.rows.length;
      var row = table.insertRow(rowCount);

      var cell = row.insertCell(0);
     
      cell.innerHTML = JSONArray[k][JSONDisplayColumn];
    }
  }

  function populateSelect(JSONArray, JSONDisplayColumn, JSONValueColumn, JSONSelectValues, selectID){
    var select = document.getElementById(selectID);

    if(select.options.length != 0){
      for(var i = select.options - 1; i > -1; i--){
        select.remove(i);
      }
    }

    for (var k in JSONArray){
      var el = document.createElement("option");
      el.textContent = JSONArray[k][JSONDisplayColumn];
      el.value = JSONArray[k][JSONValueColumn];
      select.appendChild(el);
    }

    for (var i in JSONSelectValues){
      for (var j in select.options){
        if(JSONSelectValues[i][JSONValueColumn] == select.options[j].value){
          select.options[j].selected = true;
          break;
        }
      }
    }
  }

  // TODO: This will probably be usless once connected to the back end
  function returnSelectValuesAsJSON(JSONtype, JSONDisplayColumn, JSONValueColumn, selectID){
    var select = document.getElementById(selectID);
    var newJSONString = "{" + "\"" + JSONtype + "\"" + ":[";
    
    for (var j in select.options){
      if(select.options[j].selected){
        newJSONString = newJSONString + "{" + "\"" + JSONValueColumn + "\":\"" + select.options[j].value + "\",\"" + JSONDisplayColumn + "\":\"" + select.options[j].textContent + "\"},";
      }
    }

    newJSONString = newJSONString.substring(0, newJSONString.length - 1);
    newJSONString = newJSONString + "]}";
    var newJSON = JSON.parse(newJSONString);
    return newJSON[JSONtype];
  }

function submitCreateProject(){
    var form = document.getElementById('createProject');

    var formJSON = new convertFormToJSON(form);

    var projectTitle = formJSON.projectTitle;
    
    var meetings = getElements('meetings');
    var notes = getElements('notes');
    var members = getElements('members');

    var id = <%= raw @userID %>;

    var postMeetings = [];
    var postNotes = [];
    var postMembers = [];

    for (var i = meetings.length - 1; i>=0; i--){
      postMeetings.push({"meetingID":meetings[i]});
    };

    for (var i = notes.length - 1; i>=0; i--){
      postNotes.push({"noteID":notes[i]});
    };

    postMembers.push({"userID":id});
    for (var i = members.length - 1; i>= 0; i--) {
      postMembers.push({"userID":members[i]});
    };

    var postData = JSON.stringify({
        "projectTitle":projectTitle,
        "meetings":postMeetings,
        "notes":postNotes,
        "members":postMembers
      });

    $.ajax({
      type: 'POST',
      url: 'http://csse371-04.csse.rose-hulman.edu/Project/',
      data: postData,
      success:function(data){
        $('#newProjectModal').modal('hide');
        window.location.reload(true);
      }
    });


}

//This function takes a form element and creates a json object using the name of each input in the form as the field and the value of each input as the corresponding input
function convertFormToJSON(form){
  var array = jQuery(form).serializeArray();
  var json = {};

  jQuery.each(array, function() {
    json[this.name] = this.value || '';
  });

  return json;
}

  function getElements(id){
    var elements = [];
    $( '#' + id + ' :selected' ).each( function( i, selected ) {
      elements[i] = $( selected ).val();
    });
    return elements;
  }